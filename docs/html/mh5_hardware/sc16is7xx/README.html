

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>SC16IS7XX dual UART driver &mdash; MH5 Robot D.1 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  

  
  

  
    <link rel="canonical" href="https://SYNTHesse-GIT.github.io/MH5/mh5_hardware/sc16is7xx/README.html" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="ST7789 display driver" href="../st7789/README.html" />
    <link rel="prev" title="Hardware Implementation Details" href="../docs/mh5_hardware.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> MH5 Robot
          

          
          </a>

          
            
            
              <div class="version">
                D.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../docs/mh5_hardware.html">Hardware Implementation Details</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">SC16IS7XX dual UART driver</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#why-choosing-sc16is762-chip">Why choosing SC16IS762 chip</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../st7789/README.html">ST7789 display driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../wm8960/README.html">WM8960 sound driver</a></li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">MH5 Robot</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../docs/mh5_hardware.html">Hardware Implementation Details</a> &raquo;</li>
        
      <li>SC16IS7XX dual UART driver</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/mh5_hardware/sc16is7xx/README.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <section id="sc16is7xx-dual-uart-driver">
<h1>SC16IS7XX dual UART driver<a class="headerlink" href="#sc16is7xx-dual-uart-driver" title="Permalink to this headline">¶</a></h1>
<p>The MH5 HAT uses an SC16IS762 chip to provide 2 semi-duplex TTL Dynamixel channels for communicating with the servos and sensors.</p>
<section id="why-choosing-sc16is762-chip">
<h2>Why choosing SC16IS762 chip<a class="headerlink" href="#why-choosing-sc16is762-chip" title="Permalink to this headline">¶</a></h2>
<p>While there are many options for providing a Dynamixel compliant solution for Raspberry Pi, they can be grouped in three main categories:</p>
<ol class="arabic simple">
<li><p>using the built-in serial ports</p></li>
<li><p>using USB to UART adapters</p></li>
<li><p>using SPI to UART adapters</p></li>
</ol>
<p>In order to understand the needs of a Dynamixel compliant bus, you need to be aware of the specifications of this interface. The detail about the physical definition of this interface are presented in the <a class="reference external" href="https://emanual.robotis.com/docs/en/dxl/x/xc430-w240/#ttl-communication">Robotis eManual</a>. Specifically the devices MH5 use conform to a <em>semi-duplex TTL serial communication</em> that means the data bus is shared between sending and receiving and the master (the communication controller) is responsible for switching its mode between read and write to avoid cross-talking and echo. The following diagram, extracted from the eManual describes a possible implementation of this duplex control:</p>
<figure class="align-center" id="id1">
<a class="reference internal image-reference" href="../../_images/ttl_circuit.png"><img alt="TTL Circuit" src="../../_images/ttl_circuit.png" style="width: 640px;" /></a>
<figcaption>
<p><span class="caption-text"><em>TTL Communication Circuit Example (source: Robotis eManual)</em></span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>The <strong>first option</strong> is very limited due to the following elements:</p>
<ul class="simple">
<li><p>There is only one UART available on the Raspberry PI board and typically this is used for console access to debug the system in case the other modes of access (WiFi, Ethernet) are failing. The MH5 HAT includes a CP2104 USB to UART convertor that is connected to this UART port and is providing exactly this type of functionality</p></li>
<li><p>The duplex control described above will have to be implemented using a GPIO pin from Raspberry Pi and, while this is achievable, the fact that Raspberry Pi uses a Linux system that is inherently non-real-time creates complications in timing of the switching of this GPIO and then read / write of data over the RX / TX lines of the UART, especially at high speeds (1Mbs or higher).</p></li>
</ul>
<p>The <strong>second option</strong> is used by the majority of implementations provided by Robotis, including the old <a class="reference external" href="https://emanual.robotis.com/docs/en/parts/interface/usb2dynamixel/">USB2Dynamixel</a>, the newer <a class="reference external" href="https://emanual.robotis.com/docs/en/parts/interface/u2d2/">U2D2</a> as well as the more complex <a class="reference external" href="https://emanual.robotis.com/docs/en/parts/controller/opencr10/">Open CR</a> and <a class="reference external" href="https://emanual.robotis.com/docs/en/parts/controller/opencm904/">Open CM</a>. In some previous incarnations of the MH robot (MH2 for instance) the controller board also used an USB to UART converter (<a class="reference external" href="https://ftdichip.com/products/ft4232hl/">FTDI 4232HL</a>) that provided 4 independent serial busses. This is an attractive option with the following advantages:</p>
<ul class="simple">
<li><p>Possibility to produce 2 or 4 UART channels (depending on the chip used) from one USB bus</p></li>
<li><p>Possibility to leverage the hardware control flow from RS485 protocol to drive the semi-duplex circuits above. Practically, once the circuits are configured in RS485 mode, each port can use the TXDEN pin to control in hardware the communication direction without any more involvement from the main controller.</p></li>
<li><p>Ability to handle communication speeds up to 12Mbs per channel. The typical Dynamixel devices (specifically the ones we target for the robot designs in MH group) support communication speeds up to 4.5Mbs, so the capabilities of the chip more than cover the communication needs.</p></li>
</ul>
<p>While this is an attractive option there are also a few drawbacks:</p>
<ul class="simple">
<li><p>On the Raspberry Pi platforms the USB ports are provided with standard A Ports connectors (the chips use USB 2.0 as they don’t need ultra high speed provided by USB 3.0) and this would require USB cables between the Pi and the add-on board. While this might not seem much, for small robots like MH5 the added bulk and weight off the cables is a problem (a typical USB cable connector is roughly as long as 1/2 of a Raspberry board). It is an element that must not be taken easily in consideration. Using other board (like the newer <a class="reference external" href="https://www.raspberrypi.org/products/compute-module-4/?variant=raspberry-pi-cm4001000">Compute Module 4</a>) might bypass this restriction as the USB ports (2.0) are provided as pins on the expansion sockets.</p></li>
<li><p>USB device communication include a latency that is not a problem for high volume / small number of packages exchange but becomes a limiting factor for communication protocol like Dynamixel that uses small packages and the exchange read / write follows quick successions. While this latency can be reduced to 1ms (between packages exchanges) it still creates a bottleneck when communicating at high speeds and when more than 6 devices are connected on a single bus (which is very possible for a robot with over 20 DOF).</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The latency timer constraints are also built in the <a class="reference external" href="https://github.com/ROBOTIS-GIT/DynamixelSDK">DynamixelSDK</a> code that is provided as an Open-Source by Robotis. In case of communication errors the library <a class="reference external" href="https://github.com/ROBOTIS-GIT/DynamixelSDK/blob/ad2d6136831dc3400aa43db21323c9cbfc182a34/ros/dynamixel_sdk/src/dynamixel_sdk/port_handler_linux.cpp#L33">uses the default latency (16ms)</a> to determine the timeout when exchanging packets on the serial bus. While this might impact negatively the performance only when there are errors, the fact that the framework will wait for 16ms+ before it decides there was a problem might reduce significantly the communication speed. Changing this parameter to a significantly lower value (even less than 1ms for interfaces that do not exhibit such latency like the SPI below) might significantly improve the performance of the communication and allow for faster synchronization cycles with the servos.</p>
</div>
<p>Which leaves us with the <strong>third option</strong> the SPI to UART adapters. There are a few advantages complementing the disadvantages listed for the previous options:</p>
<ul class="simple">
<li><p>It is convenient to connect such a chip directly to the SPI pins provided by Raspberry Pi without added bulk like the USB connections.</p></li>
<li><p>There are options with 2 and 4 UARTs form the same SPI connection.</p></li>
<li><p>Chips might support up to 4Mbs per bus, although the particular limits are defined by the actual SPI constraints (see bellow more details)</p></li>
<li><p>Chips will generally support hardware control which means that all direction switching will be handled in hardware and the main controller will simply read / write as a normal serial bus.</p></li>
</ul>
<p>The disadvantages for this solution are:</p>
<ul class="simple">
<li><p>While the Raspberry Pi includes two SPI buses, SPI0 and SPI1, the later one is disabled due to the use of I2S interface for the sound chip WM8960. That leaves us with only one interface SPI0 that will have to be shared with the TFT screen. This might not be really a big issue (the screen will be configured with 40Mbs communication speed and the SC16IS762 at 15Mbs which is comfortable bellow the rated communication allowed over SPI) certain conflicts might arise between the two that would impact the actual transfer speeds.</p></li>
<li><p>Typically the SPI0 is provided by the standard Device Tree for Raspberry Pi with 2 Chip Enable pins (GPIO8-CE0, GPIO7-CE1) if we plan to use a TFT with touch controller (currently the display does not use touch)that also connects over SPI we will need to provide an overlay that extends these to a third CE pin <a class="reference external" href="https://www.raspberrypi.org/forums/viewtopic.php?t=241191">see here</a>.</p></li>
<li><p>There is a standard driver for SC16IS7XX chips in the linux kernel and is subject to <a class="reference external" href="https://github.com/raspberrypi/linux/commits/rpi-5.10.y/drivers/tty/serial/sc16is7xx.c">maintenance</a> by the Raspberry Pi community. I have found many performance related problems that had to be addressed with the actions listed bellow. Once the kernel will have these issues solved some of these actions might not be necessary.</p></li>
</ul>
</section>
</section>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../st7789/README.html" class="btn btn-neutral float-right" title="ST7789 display driver" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="../docs/mh5_hardware.html" class="btn btn-neutral float-left" title="Hardware Implementation Details" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Alex Sonea.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>